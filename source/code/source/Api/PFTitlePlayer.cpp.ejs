#include "stdafx.h"
#include <playfab/<%- prefix %>TitlePlayer.h>
#include "TitlePlayer.h"

using namespace PlayFab;

HRESULT <%- prefix %>TitlePlayerDuplicateHandle(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ <%- prefix %>TitlePlayerHandle* duplicatedHandle
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(duplicatedHandle);

    *duplicatedHandle = MakeUnique<<%- prefix %>TitlePlayer>(*titlePlayerHandle).release();
    return S_OK;
}

void <%- prefix %>TitlePlayerCloseHandle(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle
) noexcept
{
    UniquePtr<<%- prefix %>TitlePlayer>{ titlePlayerHandle };
}

HRESULT <%- prefix %>TitlePlayerGetEntityHandle(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ <%- prefix %>EntityHandle* entityHandle
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(entityHandle);

    *entityHandle = MakeUnique<<%- prefix %>Entity>(titlePlayerHandle->titlePlayer).release();
    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetPlayFabIdSize(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ size_t* playFabIdSize
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(playFabIdSize);

    *playFabIdSize = titlePlayerHandle->titlePlayer->PlayFabId().size() + 1;
    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetPlayFabId(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _In_ size_t playFabIdSize,
    _Out_writes_bytes_to_opt_(playFabIdSize, playFabIdUsed) char* playFabIdBuffer,
    _Out_opt_ size_t* playFabIdUsed
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(playFabIdBuffer);

    auto playFabId = titlePlayerHandle->titlePlayer->PlayFabId();
    if (playFabId.size() + 1 > playFabIdSize)
    {
        return E_INVALIDARG;
    }

    std::strcpy(playFabIdBuffer, playFabId.data());
    if (playFabIdUsed)
    {
        *playFabIdUsed = playFabId.size() + 1;
    }

    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetCachedSessionTicketSize(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ size_t* sessionTicketSize
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(sessionTicketSize);

    auto sessionTicket = titlePlayerHandle->titlePlayer->SessionTicket();
    assert(sessionTicket);
    if (!sessionTicket)
    {
        return E_UNEXPECTED;
    }

    *sessionTicketSize = sessionTicket->size() + 1;
    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetCachedSessionTicket(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _In_ size_t sessionTicketBufferSize,
    _Out_writes_bytes_to_opt_(sessionTicketSize, *bufferUsed) char* sessionTicketBuffer,
    _Out_opt_ size_t* bufferUsed
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(sessionTicketBuffer);

    auto sessionTicket = titlePlayerHandle->titlePlayer->SessionTicket();
    assert(sessionTicket);
    if (!sessionTicket)
    {
        return E_UNEXPECTED;
    }

    if (sessionTicket->size() + 1 > sessionTicketBufferSize)
    {
        return E_INVALIDARG;
    }

    std::strcpy(sessionTicketBuffer, sessionTicket->data());
    if (bufferUsed)
    {
        *bufferUsed = sessionTicket->size() + 1;
    }
   
    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetEntityKeySize(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ size_t* bufferSize
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);

    <%- prefix %>Entity entity{ titlePlayerHandle->titlePlayer };
    return <%- prefix %>EntityGetEntityKeySize(&entity, bufferSize);
}

HRESULT <%- prefix %>TitlePlayerGetEntityKey(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _In_ size_t bufferSize,
    _Out_writes_bytes_to_(bufferSize, *bufferUsed) void* buffer,
    _Outptr_ const <%- prefix %>EntityKey** entityKey,
    _Out_opt_ size_t* bufferUsed
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);

    <%- prefix %>Entity entity{ titlePlayerHandle->titlePlayer };
    return <%- prefix %>EntityGetEntityKey(&entity, bufferSize, buffer, entityKey, bufferUsed);
}

HRESULT <%- prefix %>TitlePlayerGetCachedEntityTokenSize(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ size_t* bufferSize
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);

    <%- prefix %>Entity entity{ titlePlayerHandle->titlePlayer };
    return <%- prefix %>EntityGetCachedEntityTokenSize(&entity, bufferSize);
}

HRESULT <%- prefix %>TitlePlayerGetCachedEntityToken(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _In_ size_t bufferSize,
    _Out_writes_bytes_to_(bufferSize, *bufferUsed) void* buffer,
    _Outptr_ const <%- prefix %>EntityToken** entityToken,
    _Out_opt_ size_t* bufferUsed
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);

    <%- prefix %>Entity entity{ titlePlayerHandle->titlePlayer };
    return <%- prefix %>EntityGetCachedEntityToken(&entity, bufferSize, buffer, entityToken, bufferUsed);
}

HRESULT <%- prefix %>TitlePlayerGetPlayerCombinedInfoSize(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ size_t* bufferSize
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(bufferSize);

    auto& playerCombinedInfo = titlePlayerHandle->titlePlayer->PlayerCombinedInfo();
    if (playerCombinedInfo)
    {
        *bufferSize = playerCombinedInfo->RequiredBufferSize();
    }
    else
    {
        *bufferSize = 0;
    }
    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetPlayerCombinedInfo(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _In_ size_t bufferSize,
    _Out_writes_bytes_to_(bufferSize, *bufferUsed) void* buffer,
    _Outptr_ const <%- prefix %>GetPlayerCombinedInfoResultPayload** playerCombinedInfoPtr,
    _Out_opt_ size_t* bufferUsed
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(buffer);
    RETURN_HR_INVALIDARG_IF_NULL(playerCombinedInfoPtr);

    ModelBuffer b{ buffer, bufferSize };
    auto& playerCombinedInfo = titlePlayerHandle->titlePlayer->PlayerCombinedInfo();
    if (playerCombinedInfo)
    {
        auto copyResult = playerCombinedInfo->Copy(b);
        RETURN_IF_FAILED(copyResult.hr);
        *playerCombinedInfoPtr = copyResult.ExtractPayload();
    }
    else
    {
        TRACE_INFORMATION("<%- prefix %>GetPlayerCombinedInfoResultPayload not cached for this TitlePlayer");
        *playerCombinedInfoPtr = nullptr;
    }

    if (bufferUsed)
    {
        *bufferUsed = bufferSize - b.RemainingSpace();
    }

    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetLastLoginTime(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ time_t* lastLoginTimePointer
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(lastLoginTimePointer);

    auto lastLoginTime = titlePlayerHandle->titlePlayer->LastLoginTime();
    if (lastLoginTime)
    {
        *lastLoginTimePointer = *lastLoginTime;
    }
    else
    {
        // Set to default per header docs
        *lastLoginTimePointer = time_t{ 0 };
    }

    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetUserSettings(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ <%- prefix %>AuthenticationUserSettings* userSettingsPtr
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(userSettingsPtr);

    auto& userSettings = titlePlayerHandle->titlePlayer->UserSettings();
    if (userSettings)
    {
        *userSettingsPtr = titlePlayerHandle->titlePlayer->UserSettings()->Model();
    }
    else
    {
        TRACE_INFORMATION("<%- prefix %>AuthenticationUserSettings not cached for this TitlePlayer");
        *userSettingsPtr = {};
    }
    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetTreatmentAssignmentSize(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _Out_ size_t* bufferSize
) noexcept
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(bufferSize);

    auto& treatmentAssignment = titlePlayerHandle->titlePlayer->TreatmentAssignment();
    if (treatmentAssignment)
    {
        *bufferSize = treatmentAssignment->RequiredBufferSize();
    }
    else
    {
        *bufferSize = 0;
    }
    return S_OK;
}

HRESULT <%- prefix %>TitlePlayerGetTreatmentAssignment(
    _In_ <%- prefix %>TitlePlayerHandle titlePlayerHandle,
    _In_ size_t bufferSize,
    _Out_writes_bytes_to_(bufferSize, *bufferUsed) void* buffer,
    _Outptr_ const <%- prefix %>TreatmentAssignment** treatmentAssignmentPtr,
    _Out_opt_ size_t* bufferUsed
) noexcept 
{
    RETURN_HR_INVALIDARG_IF_NULL(titlePlayerHandle);
    RETURN_HR_INVALIDARG_IF_NULL(buffer);
    RETURN_HR_INVALIDARG_IF_NULL(treatmentAssignmentPtr);

    ModelBuffer b{ buffer, bufferSize };
    auto& treatmentAssignment = titlePlayerHandle->titlePlayer->TreatmentAssignment();
    if (treatmentAssignment)
    {
        auto copyResult = treatmentAssignment->Copy(b);
        RETURN_IF_FAILED(copyResult.hr);
        *treatmentAssignmentPtr = copyResult.ExtractPayload();
    }
    else
    {
        TRACE_INFORMATION("<%- prefix %>TreatmentAssignment not cached for this TitlePlayer");
        *treatmentAssignmentPtr = nullptr;
    }

    if (bufferUsed)
    {
        *bufferUsed = bufferSize - b.RemainingSpace();
    }

    return S_OK;
}
